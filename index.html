<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e0e0e0' rx='16'/><text x='50%' y='45%' dominant-baseline='central' text-anchor='middle' font-size='85' font-family='Arial' font-weight='bold' fill='%231e1e1e'>ç™½</text></svg>">
    <title>Shiro</title>
    <meta name="description" content="A clean, distraction-free text editor for focused writing.">
    <script>
        // Set theme before CSS is applied to avoid screen flashing
        (function () {
            const savedTheme = localStorage.getItem('shiroTheme');
            const theme = savedTheme ||
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --bg: #130f0c;
            --text: #dfe4e2;
            --placeholder: #7b807a;
            --transition: 0.3s ease;
            --hover-accent: #b9391b;
        }

        [data-theme="light"] {
            --bg: #dfe4e2;
            --text: #130f0c;
            --placeholder: #7b807a;
        }

        body {
            margin: 0;
            font: 18px/1.6 "Monaco", "Courier New", monospace;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            transition: background var(--transition);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            padding: 18px 20px;
            gap: 20px;
        }

        .controls>div {
            display: flex;
            gap: 20px;
        }

        .btn {
            cursor: pointer;
            opacity: 0.5;
            font-size: 14px;
            transition: opacity var(--transition), color var(--transition);
            user-select: none;
            color: var(--text);
        }

        .btn:hover {
            opacity: 1;
            color: var(--hover-accent);
        }

        .controls.hidden .btn {
            opacity: 0;
        }

        main {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #editor {
            width: 70vw;
            height: 70vh;
            padding: 2.5vh;
            font: inherit;
            background: transparent;
            color: var(--text);
            border: none;
            outline: none;
            resize: none;
            transition: opacity var(--transition);
            tab-size: 4;
        }

        #editor::placeholder {
            color: var(--placeholder);
        }

        ::selection {
            background-color: rgba(185, 57, 27, 0.5);
            color: inherit;
        }
    </style>
</head>

<body>
    <div class="controls" id="top">
        <div>
            <span class="btn" data-action="download">Download</span>
            <span class="btn" data-action="clear">Clear</span>
        </div>
        <div>
            <span class="btn" data-action="fullscreen">Fullscreen</span>
            <span class="btn" data-action="theme">Light</span>
        </div>
    </div>

    <main>
        <textarea id="editor" placeholder="Start writing..."></textarea>
    </main>

    <div class="controls" id="bottom">
        <div>
            <span class="btn" data-action="about">About</span>
        </div>
        <div>
            <span class="btn" id="count" data-action="count">0 words</span>
        </div>
    </div>

    <script>
        class Shiro {
            constructor() {
                this.editor = document.getElementById('editor');
                this.controls = document.querySelectorAll('.controls');
                this.countDisplay = document.getElementById('count');
                this.theme = localStorage.getItem('shiroTheme') ||
                    (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                this.countMode = localStorage.getItem('shiroCountMode') || 'words';
                this.visible = true;

                this.init();
            }

            init() {
                this.loadText();
                this.setTheme(this.theme);
                this.bindEvents();
                this.updateCount();
                this.editor.focus();
            }

            bindEvents() {
                // Editor events
                this.editor.addEventListener('input', () => {
                    this.saveText();
                    if (this.visible) {
                        this.updateCount();
                    }
                    this.hide();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const modKey = isMac ? e.metaKey : e.ctrlKey;

                    if (e.key === 'Tab' && e.target === this.editor) {
                        e.preventDefault();
                        document.execCommand('insertText', false, '\t');
                        return;
                    }

                    // Save text: Ctrl+S (Windows/Linux) or Cmd+S (Mac)
                    if (modKey && e.key === 's') {
                        e.preventDefault();
                        this.download();
                        return;
                    }

                    // Clear text: Ctrl+K (Windows/Linux) or Cmd+K (Mac)
                    if (modKey && e.key === 'k') {
                        e.preventDefault();
                        this.clearWithConfirmation();
                        return;
                    }

                    // Theme toggle: Shift+Ctrl+T (Windows/Linux) or Shift+Cmd+T (Mac)
                    if (modKey && e.shiftKey && e.key === 'T') {
                        e.preventDefault();
                        this.toggleTheme();
                        return;
                    }

                    // Fullscreen toggle: Shift+Ctrl+F (Windows/Linux) or Shift+Cmd+F (Mac)
                    if (modKey && e.shiftKey && e.key === 'F') {
                        e.preventDefault();
                        this.fullscreen();
                        return;
                    }
                });

                // Always focus on editor on keydown
                window.addEventListener('keydown', () => {
                    this.editor.focus();
                });

                // Control buttons
                const actions = {
                    download: () => this.download(),
                    clear: () => this.clearWithConfirmation(),
                    fullscreen: () => this.fullscreen(),
                    theme: () => this.toggleTheme(),
                    about: () => this.about(),
                    count: () => this.toggleCountMode()
                };

                document.addEventListener('click', e => {
                    const action = e.target.dataset.action;
                    if (action && actions[action]) {
                        actions[action]();
                        this.editor.focus();
                    } else if (e.target !== this.editor) {
                        this.editor.focus();
                    }
                });

                // Show controls on mouse movement
                document.addEventListener('mousemove', () => this.show());

                // Fullscreen change
                document.addEventListener('fullscreenchange', () => {
                    const btn = document.querySelector('[data-action="fullscreen"]');
                    btn.textContent = document.fullscreenElement ? 'Normal' : 'Fullscreen';
                });

                // Save cursor position when it moves
                this.editor.addEventListener('selectionchange', () => {
                    this.saveCursorPosition();
                });
            }

            saveText() {
                localStorage.setItem('shiroSavedText', this.editor.value);
            }

            loadText() {
                this.editor.value = localStorage.getItem('shiroSavedText') || '';
                this.loadCursorPosition();
                this.updateCount();
            }

            saveCursorPosition() {
                localStorage.setItem('shiroCursorPosition', this.editor.selectionStart);
            }

            loadCursorPosition() {
                const saved = localStorage.getItem('shiroCursorPosition');
                if (saved) {
                    const position = parseInt(saved);
                    setTimeout(() => {
                        this.editor.setSelectionRange(position, position);
                        this.editor.focus();
                    }, 0);
                }
            }

            updateCount() {
                const text = this.editor.value;
                let count, label;

                if (this.countMode === 'words') {
                    count = text.trim().split(/\s+/).filter(Boolean).length;
                    label = `word${count !== 1 ? 's' : ''}`;
                } else {
                    count = text.length;
                    label = `character${count !== 1 ? 's' : ''}`;
                }

                this.countDisplay.textContent = `${count} ${label}`;
            }

            toggleCountMode() {
                this.countMode = this.countMode === 'words' ? 'characters' : 'words';
                localStorage.setItem('shiroCountMode', this.countMode);
                this.updateCount();
            }

            hide() {
                if (this.visible) {
                    this.controls.forEach(c => c.classList.add('hidden'));
                    this.visible = false;
                }
            }

            show() {
                if (!this.visible) {
                    this.controls.forEach(c => c.classList.remove('hidden'));
                    this.visible = true;
                    this.updateCount();
                }
            }

            setTheme(theme = this.theme) {
                document.documentElement.setAttribute('data-theme', theme);
                document.querySelector('[data-action="theme"]').textContent = theme === 'dark' ? 'Light' : 'Dark';
                localStorage.setItem('shiroTheme', theme);
                this.theme = theme;
            }

            // Actions
            download() {
                const timestamp = new Date().toISOString().slice(0, 16).replace(/[:T]/g, m => m === 'T' ? '_' : '-');
                const blob = new Blob([this.editor.value], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                Object.assign(document.createElement('a'), {
                    href: url,
                    download: `shiro_${timestamp}.txt`
                }).click();

                URL.revokeObjectURL(url);
            }

            clearWithConfirmation() {
                if (this.editor.value.trim()) {
                    if (confirm('Are you sure you want to clear all text?')) {
                        this.clear();
                    }
                } else {
                    this.clear();
                }
            }

            clear() {
                this.editor.style.opacity = '0';
                setTimeout(() => {
                    this.editor.value = '';
                    this.editor.style.opacity = '1';
                    localStorage.removeItem('shiroSavedText');
                    this.updateCount();
                }, 300);
            }

            fullscreen() {
                document.fullscreenElement
                    ? document.exitFullscreen?.()
                    : document.documentElement.requestFullscreen?.();
            }

            toggleTheme() {
                const newTheme = this.theme === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme);
            }

            about() {
                window.open('https://github.com/vsakkas/shiro', '_blank');
            }
        }

        // Start Shiro
        new Shiro();
    </script>
</body>
</html>
